<!-- ****************************************
     |docname| - main template for this theme
     **************************************** -->
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>11.6. constexpr classes &#8212; CISC 187 Course Reader Overview</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/matrixeq.css?v=58BC228F" />
    <link rel="stylesheet" type="text/css" href="../_static/CodeChat.css" />
    <link rel="stylesheet" type="text/css" href="../_static/webgldemo.css?v=B36B48D" />
    <link rel="stylesheet" type="text/css" href="../_static/webglinteractive.css?v=910DF1E1" />
    <link rel="stylesheet" type="text/css" href="../_static/accessibility.css?v=50109A2C" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/637.fafafbd97df8a0d1.css?v=B5361BC8" />
    <link rel="stylesheet" type="text/css" href="../_static/runestone.e4d5592da655219f.css?v=32648AE5" />



    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/matrixeq.js?v=D64CFA5A"></script>
    <script src="../_static/animationbase.js?v=A043C3A7"></script>
    <script src="../_static/html4css1.css?v=4533ACD3"></script>
    <script src="../_static/webglinteractive.js?v=2B768384"></script>
    <script src="../_static/FileSaver.min.js?v=8408C997"></script>
    <script src="../_static/runtime.b0f8547c48f16a9f.bundle.js?v=2731F567"></script>
    <script src="../_static/637.d54be67956c5c660.bundle.js?v=915B1670"></script>
    <script src="../_static/runestone.0e9550fe42760516.bundle.js?v=71AD37BA"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="12. Stacks and Queues" href="../stack/index.html" />
    <link rel="prev" title="11.5. Allocators" href="allocators.html" />


<link rel="shortcut icon" href="/cisc187-reader/static/favicon.ico" type="image/ico" />


<script>
  eBookConfig = {};
  
    eBookConfig.useRunestoneServices = false;
    eBookConfig.host = 'https://daveparillo.github.io/cisc187-reader/' || 'http://127.0.0.1:8000';
    eBookConfig.app = eBookConfig.host+'/cisc187-reader';
    eBookConfig.course = 'cisc187-reader';
    eBookConfig.basecourse = 'cisc187-reader';
    eBookConfig.isLoggedIn = false;
    eBookConfig.enableCompareMe = eBookConfig.useRunestoneServices;
    eBookConfig.new_server_prefix = '';
  
  eBookConfig.ajaxURL = eBookConfig.app+'/ajax/';
  eBookConfig.logLevel = 0;
  eBookConfig.loginRequired = false;
  eBookConfig.build_info = "unknown";
  eBookConfig.python3 = true;
  eBookConfig.acDefaultLanguage = 'cpp' ? 'cpp' : 'python'
  eBookConfig.runestone_version = '6.2.1';
  eBookConfig.jobehost = 'https://red-voice-1370.fly.dev/http://jobe2.cosc.canterbury.ac.nz';
  eBookConfig.proxyuri_runs = '/jobe/index.php/restapi/runs/';
  eBookConfig.proxyuri_files = '/jobe/index.php/restapi/files/';
  eBookConfig.enable_chatcodes = false ? false : false;
  eBookConfig.enableScratchAC = true;

</script>

<!-- Ad Serving Headers Only serve ads to Anonymous Users -->



  </head><body>


<!-- Begin navbar -->
<div id="navbar" class="navbar navbar-default navbar-fixed-top" role="navigation">

  <div class="container">

    <div class="navbar-header">
      <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
      <button type='button' class='navbar-toggle' data-toggle="collapse" data-target=".navbar-ex1-collapse" aria-label="navbar toggle">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div>
        
        
          <div class="brand-logo"><img src="../_static/img/RAIcon.png" alt=""></div>
        
        <a class="navbar-brand" href="../index.html" aria-label="index-page">
          
          cisc187-reader
        </a>
      </div>
    </div>



    <div class="navbar-collapse collapse navbar-ex1-collapse">
      <ul class="nav navbar-nav navbar-right" >

        <li class="divider-vertical"></li>
        <li><span id="browsing_warning"></span></li>

        <!-- social media dropdown -->
        <!-- end social media dropdown -->

        <li class="divider-vertical"></li>
        <!-- search dropdown -->
        <li class="dropdown">
          <a class="dropdown-toggle" href="#" data-toggle="dropdown">
            <i class="glyphicon glyphicon-search" style='opacity:0.9;'><span class="visuallyhidden" aria-label="Search">Search</span></i>
          </a>
          <ul class='dropdown-menu'>
            
                <li><a href='../index.html' aria-label="index-page">Table of Contents</a></li>
            
            <li><a href='../genindex.html'>Book Index</a></li>
            <li class="divider"></li>
            <li style="width: 240px;">
              <form class="navbar-search" style="margin:10px;" action="../search.html" method="get">
                <div class="input-group">
                  <input type="text" class="form-control" name="q" placeholder="Search this book" />
                  <span class="input-group-btn">
                    <button class="btn btn-primary" style="margin:0;" type="submit">
                      <i class="glyphicon glyphicon-search"></i>
                    </button>
                  </span>
                </div><!-- /input-group -->
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
            </li>
          </ul>
        </li>
        <!-- end search dropdown -->

        <li class="divider-vertical"></li>

        
        <li class="divider-vertical"></li>
        <!-- <li id="scratch_ac_link"><a href="javascript:ACFactory.toggleScratchActivecode()">Scratch ActiveCode</a></li> -->

        <!-- <li class="dropdown">             -->
          <li id="scratch_ac_link" class="dropdown"><a href="javascript:runestoneComponents.popupScratchAC()">
              <i class="glyphicon glyphicon-pencil" style="opacity:0.9;"><span class="visuallyhidden" aria-label="Scratch Activecode" >Scratch Activecode</span></i></a></li>
        <!-- </li> -->

        <li class="divider-vertical"></li>

        
      </ul>

      <ul class="nav navbar-nav">
        <li class="divider-vertical"></li>
        
          
          <li class="divider-vertical"></li>
        
        <!-- 
          
  <li id="relations-prev" title="Previous Chapter - <span class="section-number">11.5. </span>Allocators" data-toggle="tooltip">
    <a href="allocators.html" >
      <i class='glyphicon glyphicon-backward' style='opacity:0.9;'></i>
    </a>
  </li>
  
  <li id="relations-next" title='Next Chapter - <span class="section-number">12. </span>Stacks and Queues' data-toggle="tooltip" >              
    <a href="../stack/index.html" >
        <i class='glyphicon glyphicon-forward' style='opacity:0.9;'></i>
    </a>
  </li>
  <li class="divider-vertical"></li>

<script>
  opts = {'placement':'bottom',
          'selector': '',
          'delay': { show: 100, hide: 50}
         };

  window.addEventListener('load', (event) => {
    $('#relations-prev').tooltip(opts);
    $('#relations-next').tooltip(opts);
  });
</script>
        -->
        
          <li></li>
        
      </ul>
      </div> <!-- navbar-collapse -->
    </div> <!-- navbar -->
  </div> <!-- container -->


<div class="container" id="continue-reading"></div>

<div class="container" id="main-content" role="main">

<!-- Ad Serving for Runestone Campaign -->


  
  <section id="constexpr-classes">
<span id="index-0"></span><h1><span class="section-number">11.6. </span><code class="docutils literal notranslate"><span class="pre">constexpr</span></code> classes<a class="headerlink" href="#constexpr-classes" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference external" href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rconst-immutable">C++ Core guidelines generally</a>
prefers constant data and objects over mutable objects and data when possible.
Previously, when we have used <code class="docutils literal notranslate"><span class="pre">const</span></code> and <code class="docutils literal notranslate"><span class="pre">constexpr</span></code> it has generally been
limited to variables and functions.
But what about an entire class?
Can we design a class that can only store a single value?
Even if we can, should we?</p>
<p>Let’s answer that last question first.</p>
<p>Immutable object provide several important benefits:</p>
<ul class="simple">
<li><p>Objects that are immutable are easier to reason about.
They don’t surprise you with unexpected behaviors.</p></li>
<li><p>It can prevent errors when an object changes its state unexpectedly.</p></li>
<li><p>Interfaces that accept constant objects are easier to work with and debug.</p></li>
<li><p>Although we don’t discuss multi-threaded programming in this course,
constant objects are inherently thread safe - that is they can safely be
accessed simultaneously by concurrent independent execution threads.</p></li>
<li><p>Gives the compiler more tools to:</p>
<ul>
<li><p>Report errors in usage</p></li>
<li><p>Make optimizations (more on this in a moment)</p></li>
</ul>
</li>
</ul>
<p>Awesome. So how can we make an immutable class?</p>
<p>Simply by declaring all of the class functions as <code class="docutils literal notranslate"><span class="pre">constexpr</span></code>!</p>
<p>Let’s examine a value class for a distance in meters.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">length</span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">distance</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">explicit</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">:</span><span class="n">m</span><span class="p">{</span><span class="n">value</span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">{}</span><span class="w"></span>

<span class="w">    </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w">       </span><span class="c1">// meters</span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>

<span class="p">}</span><span class="w"> </span><span class="c1">// end namespace length</span>
</pre></div>
</div>
<p>All member functions, including any constructors must be <code class="docutils literal notranslate"><span class="pre">const</span></code> or <code class="docutils literal notranslate"><span class="pre">constexpr</span></code>.
The private data is not constant.
That’s OK, because we won’t allow any function to change it.</p>
<p>Recall that <code class="docutils literal notranslate"><span class="pre">constexpr</span></code> member functions are implicitly <code class="docutils literal notranslate"><span class="pre">const</span></code> member functions -
that is, they cannot change the state of the object.</p>
<p>After we define our constructor, we can add other functions as appropriate.
In our case we want to perform basic math operations on distances.
And in keeping our use of the ‘standard pattern’ for arithmetic overloads,
we want to create member functions like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="k">operator</span><span class="o">+=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">distance</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Normally when we implement these functions we modify the current object
and return <code class="docutils literal notranslate"><span class="pre">*this</span></code>.
But we can’t do that if our objects are immutable.
What we do instead is construct a new distance object by combining the
two objects on either side of the operand:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="k">operator</span><span class="o">+=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">distance</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The current object is still involved - it is the object on the left-hand side
of the expression, but we do not modify it.</p>
<p>An important implication of this implementation is that every change in state
creates a new object to store it.</p>
<p>Adding the overloads for addition, subtraction, multiplication, and division
yields the following:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">length</span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">distance</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">:</span><span class="n">m</span><span class="p">{</span><span class="n">i</span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">{}</span><span class="w"></span>

<span class="w">      </span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="k">operator</span><span class="o">+=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">distance</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="k">operator</span><span class="o">-=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">distance</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="k">operator</span><span class="o">*=</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">scalar</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">scalar</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="k">operator</span><span class="o">/=</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">scalar</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="n">scalar</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w">       </span><span class="c1">// meters</span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>

<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">distance</span><span class="w"> </span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">distance</span><span class="o">&amp;</span><span class="w"> </span><span class="n">rhs</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="n">lhs</span><span class="o">+=</span><span class="w"> </span><span class="n">rhs</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="k">operator</span><span class="o">-</span><span class="p">(</span><span class="n">distance</span><span class="w"> </span><span class="n">lhs</span><span class="p">,</span><span class="k">const</span><span class="w"> </span><span class="n">distance</span><span class="o">&amp;</span><span class="w"> </span><span class="n">rhs</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="n">lhs</span><span class="o">-=</span><span class="w"> </span><span class="n">rhs</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="k">operator</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">scalar</span><span class="p">,</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="n">a</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="n">a</span><span class="o">*=</span><span class="n">scalar</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="k">operator</span><span class="o">/</span><span class="p">(</span><span class="n">distance</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">denominator</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="n">a</span><span class="o">/=</span><span class="n">denominator</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"> </span><span class="c1">// end namespace length</span>
</pre></div>
</div>
<p>We might choose to add more, but these 4 demonstrate the basic idea.</p>
<p>We should also implement the complete set of relational overloads,
since there is no reason to treat distances as anything other than
completely regular types.</p>
<p>Working exclusively in meters is not always convenient, so we can also add
distance literals so that we can easily work with numbers that are either
meters or kilometers:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">length</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">namespace</span><span class="w"> </span><span class="nn">unit</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="n">_km</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">){</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">d</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="n">_m</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">m</span><span class="p">){</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="c1">// end namespace unit</span>
<span class="p">}</span><span class="w"> </span><span class="c1">// end namespace length</span>
</pre></div>
</div>
<p>Notice that these overloads are non-friend non-member functions.
Each simply constructs a new distance based on the units implied by the literal used.</p>
<div id='constexpr_distance_tabbed' data-component="tabbedStuff"  class='alert alert-warning '><div data-component="tab" data-tabname="Using distance" >
<p>Finally we can write some functions that use our constexpr class.</p>
<p>Here we add a free function tthat takes a list of distances and
accumulates an average.
We could have used <a class="reference external" href="https://en.cppreference.com/w/cpp/numeric/accumulate">std::accumulate</a>,
or in C++17 and later, we could use <a class="reference external" href="https://en.cppreference.com/w/cpp/numeric/reduce">std::reduce</a>
to achive the same outcome.</p>
<p>Once we have that, we can define some distances,
generate a few weeks works of values and compute the final result.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">constexpr</span><span class="w"> </span><span class="n">length</span><span class="o">::</span><span class="n">distance</span><span class="w"> </span><span class="nf">average_distance</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">initializer_list</span><span class="o">&lt;</span><span class="n">length</span><span class="o">::</span><span class="n">distance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">distances</span><span class="p">){</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="o">::</span><span class="n">distance</span><span class="p">{</span><span class="mf">0.0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">d</span><span class="o">:</span><span class="w"> </span><span class="n">distances</span><span class="p">)</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="o">/</span><span class="n">distances</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span><span class="w"></span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">length</span><span class="o">::</span><span class="nn">unit</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">63.0</span><span class="n">_km</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">commute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">work</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">gym</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1600.0</span><span class="n">_m</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">shopping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1200.0</span><span class="n">_m</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">week1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="n">commute</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gym</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shopping</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">week2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="n">commute</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">gym</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">week3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="n">gym</span><span class="w">     </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">shopping</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">week4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="o">*</span><span class="n">gym</span><span class="w">     </span><span class="o">+</span><span class="w"> </span><span class="n">shopping</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">avg_travel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">average_distance</span><span class="p">({</span><span class="n">week1</span><span class="p">,</span><span class="n">week2</span><span class="p">,</span><span class="n">week3</span><span class="p">,</span><span class="n">week4</span><span class="p">});</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">avg_travel</span><span class="p">);</span><span class="w"> </span><span class="c1">// 264000m</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div data-component="tab" data-tabname="Run It" >
<p>This example does not print a value, but merely returns the final value
from main.
If you’re curious as to why, copy this code into
the online <a class="reference external" href="https://godbolt.org">Compiler explorer</a></p>

<div class="runestone explainer ac_section ">
<div data-component="activecode" id=ac_memory_constexpr_classes data-question_label="11.6.1">
<div id=ac_memory_constexpr_classes_question class="ac_question col-md-12">

</div>
<textarea data-lang="cpp" id="ac_memory_constexpr_classes_editor" 
      data-timelimit=25000     
    data-audio=''      
    data-compileargs="[&#x27;-Wall&#x27;, &#x27;-Wextra&#x27;, &#x27;-pedantic&#x27;, &#x27;-std=c++1z&#x27;]"       data-wasm=/_static
     style="visibility: hidden;">
#include <cstdlib>
#include <initializer_list>

namespace length{

  class distance{
    public:
      explicit constexpr distance(double i)
        :m{i}
      {}

      constexpr distance operator+=(const distance& other) {
        return distance(m + other.m);
      }
      constexpr distance operator-=(const distance& other) {
        return distance(m - other.m);
      }
      constexpr distance operator*=(double scalar) {
        return distance(m*scalar);
      }
      constexpr distance operator/=(int scalar) {
        return distance(m/scalar);
      }

      constexpr operator int() const { return static_cast<int>(m);}

    private:
      double m;         // meters
  };

  constexpr distance operator+(distance lhs, const distance& rhs){
    return distance(lhs+= rhs);
  }
  constexpr distance operator-(distance lhs,const distance& rhs){
    return distance(lhs-= rhs);
  }
  constexpr distance operator*(int scalar, distance a){
    return distance(a*=scalar);
  }
  constexpr distance operator/(distance a, size_t denominator){
    return distance(a/=denominator);
  }

  namespace unit{
    constexpr distance operator "" _km(long double d){
      return distance(1000*d);
    }
    constexpr distance operator "" _m(long double m){
      return distance(m);
    }
  }

} // end namespace length

constexpr length::distance average_distance(std::initializer_list<length::distance> distances){
  auto sum = length::distance{0.0};
  for (auto d: distances) sum = sum + d;
  return sum/distances.size();
}

int main(){
  using namespace length::unit;

  constexpr auto work = 63.0_km;
  constexpr auto commute = 2 * work;
  constexpr auto gym = 2 * 1600.0_m;
  constexpr auto shopping = 2 * 1200.0_m;

  constexpr auto week1 = 4*commute + gym + shopping;
  constexpr auto week2 = 4*commute + 2*gym;
  constexpr auto week3 = 4*gym     + 2*shopping;
  constexpr auto week4 = 5*gym     + shopping;

  constexpr auto avg_travel = average_distance({week1,week2,week3,week4});

  return int(avg_travel); // 264000m
}
</textarea>
</div>
</div>
</div>
    </div>

<p>Declaring all variables as <code class="docutils literal notranslate"><span class="pre">constexpr</span></code> means all instances of distance and all functions are constant expressions.
The compiler performs all of these operations at compile time.
That means the <em>entire program will be executed at compile time</em> and
all the program variables and instances are immutable.</p>
<div class="admonition-try-this admonition">
<p class="admonition-title">Try This!</p>
<p>Copy this code into the online <a class="reference external" href="https://godbolt.org">Compiler explorer</a>
and see what the generated code looks like.</p>
<p>Try setting the compiler optimiztion in the explorer “compiler options” text box:
<cite>-O2</cite> - does anything change? It should!</p>
<p>Is the final symbol code what you expected?</p>
<p>What do you think is going on here?</p>
</div>
<hr class="docutils" />
<div class="admonition-more-to-explore admonition">
<p class="admonition-title">More to Explore</p>
<ul class="simple">
<li><p>The content on this page was adapted from
Rainer Grimm’s blog <em>MODERNES C++</em>: <a class="reference external" href="https://www.modernescpp.com/index.php/immutable-data">Immutable data</a></p></li>
<li><p>From cppreference.com</p>
<ul>
<li><p><a class="reference external" href="https://en.cppreference.com/w/cpp/language/constexpr">constexpr</a></p></li>
</ul>
</li>
<li><p>C++ Core Guidelines</p>
<ul>
<li><p><a class="reference external" href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rconst-immutable">Con: Constants and immutability</a></p></li>
<li><p><a class="reference external" href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#con5-use-constexpr-for-values-that-can-be-computed-at-compile-time">Con.5: Use constexpr for values that can be computed at compile time</a></p></li>
</ul>
</li>
</ul>
</div>
</section>


  <div id="scprogresscontainer">
    You have attempted <span id="scprogresstotal"></span> of <span id="scprogressposs"></span> activities on this page <div id="subchapterprogress" aria-label="Page progress"></div>
  </div>

  <ul role="navigation" class="nextprev-list nextprev-list" aria-label="Change page">
<li id="relations-prev" class="navLink" title='Previous Section - 11.5. Allocators' data-toggle="tooltip">
  <a href="allocators.html" aria-label="Previous - 11.5. Allocators">
    <i class='prevNav glyphicon glyphicon-chevron-left'  style="top:50%; transform:translateY(-50%)translateX(-50%); left: 50%; color:black;"></i>
  </a>
</li>

  <li id="relations-next" class="navLink" title='Next Section - 12. Stacks and Queues' data-toggle="tooltip" >
    <a href="../stack/index.html" aria-label="Next - 12. Stacks and Queues">
      <i id="relationsNextIcon" class='nextNav glyphicon glyphicon-chevron-right' style="top:50%; transform:translateY(-50%)translateX(-50%); left: 50%; color:black; "></i>
    </a>
  </li>
</ul>

<script>
window.addEventListener('load', (event) => {
  $('#relations-prev').tooltip({'placement': 'right', 'delay': { show: 100, hide: 50}});
  $('#relations-next').tooltip({'placement': 'left', 'delay': { show: 100, hide: 50}});
});
</script>

</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      
      | <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017-2022 Dave Parillo.
      Created using <a href="http://runestoneinteractive.org/">Runestone</a> 6.2.1.
    </p>
  </div>
</footer>




<script>
  window.addEventListener('load', (event) => {
    runestoneComponents.getSwitch();
  });
</script>


  </body>
</html>