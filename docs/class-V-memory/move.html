<!-- ****************************************
     |docname| - main template for this theme
     **************************************** -->
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>11.4. Moving memory &#8212; CISC 187 Course Reader Overview</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/matrixeq.css?v=58BC228F" />
    <link rel="stylesheet" type="text/css" href="../_static/CodeChat.css" />
    <link rel="stylesheet" type="text/css" href="../_static/webgldemo.css?v=B36B48D" />
    <link rel="stylesheet" type="text/css" href="../_static/webglinteractive.css?v=910DF1E1" />
    <link rel="stylesheet" type="text/css" href="../_static/accessibility.css?v=50109A2C" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/637.0fa6cababf056764.css?v=F9484CEF" />
    <link rel="stylesheet" type="text/css" href="../_static/runestone.3eb60bc006ae9a54.css?v=3A5A250C" />



    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/matrixeq.js?v=D64CFA5A"></script>
    <script src="../_static/animationbase.js?v=A043C3A7"></script>
    <script src="../_static/html4css1.css?v=4533ACD3"></script>
    <script src="../_static/webglinteractive.js?v=2B768384"></script>
    <script src="../_static/FileSaver.min.js?v=8408C997"></script>
    <script src="../_static/runtime.66b619f51b746382.bundle.js?v=C3F69EE5"></script>
    <script src="../_static/637.d54be67956c5c660.bundle.js?v=915B1670"></script>
    <script src="../_static/runestone.ecc6dff5cad8b815.bundle.js?v=AE959292"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="11.5. Allocators" href="allocators.html" />
    <link rel="prev" title="11.3. Lvalues, rvalues, and references" href="rvalue.html" />


<link rel="shortcut icon" href="/cisc187-reader/static/favicon.ico" type="image/ico" />



<link rel="canonical" href="https://{{canonical_host}}{{new_server_prefix}}/books/published/{{base_course}}/{{pagepath}}" />


<script>
  eBookConfig = {};
  
    eBookConfig.useRunestoneServices = false;
    eBookConfig.host = 'https://daveparillo.github.io/cisc187-reader/' || 'http://127.0.0.1:8000';
    eBookConfig.app = eBookConfig.host+'/cisc187-reader';
    eBookConfig.course = 'cisc187-reader';
    eBookConfig.basecourse = 'cisc187-reader';
    eBookConfig.isLoggedIn = false;
    eBookConfig.enableCompareMe = eBookConfig.useRunestoneServices;
    eBookConfig.new_server_prefix = '';
  
  eBookConfig.ajaxURL = eBookConfig.app+'/ajax/';
  eBookConfig.logLevel = 0;
  eBookConfig.loginRequired = false;
  eBookConfig.build_info = "unknown";
  eBookConfig.python3 = true;
  eBookConfig.acDefaultLanguage = 'cpp' ? 'cpp' : 'python'
  eBookConfig.runestone_version = '6.6.2';
  eBookConfig.jobehost = 'https://red-voice-1370.fly.dev/http://jobe2.cosc.canterbury.ac.nz';
  eBookConfig.proxyuri_runs = '/jobe/index.php/restapi/runs/';
  eBookConfig.proxyuri_files = '/jobe/index.php/restapi/files/';
  eBookConfig.enable_chatcodes = false ? false : false;
  eBookConfig.enableScratchAC = true;

</script>

<!-- Ad Serving Headers Only serve ads to Anonymous Users -->



  </head><body>


<!-- Begin navbar -->
<div id="navbar" class="navbar navbar-default navbar-fixed-top" role="navigation">

  <div class="container">

    <div class="navbar-header">
      <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
      <button type='button' class='navbar-toggle' data-toggle="collapse" data-target=".navbar-ex1-collapse" aria-label="navbar toggle">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div>
        
        
          <div class="brand-logo"><img src="../_static/img/RAIcon.png" alt=""></div>
        
        <a class="navbar-brand" href="../index.html" aria-label="index-page">
          
          cisc187-reader
        </a>
      </div>
    </div>



    <div class="navbar-collapse collapse navbar-ex1-collapse">
      <ul class="nav navbar-nav navbar-right" >

        <li class="divider-vertical"></li>

        <!-- social media dropdown -->
        <!-- end social media dropdown -->

        <li class="divider-vertical"></li>
        <!-- search dropdown -->
        <li class="dropdown">
          <a class="dropdown-toggle" href="#" data-toggle="dropdown">
            <i class="glyphicon glyphicon-search" style='opacity:0.9;'><span class="visuallyhidden" aria-label="Search">Search</span></i>
          </a>
          <ul class='dropdown-menu'>
            
                <li><a href='../index.html' aria-label="index-page">Table of Contents</a></li>
            
            <li><a href='../genindex.html'>Book Index</a></li>
            <li class="divider"></li>
            <li style="width: 240px;">
              <form class="navbar-search" style="margin:10px;" action="../search.html" method="get">
                <div class="input-group">
                  <input type="text" class="form-control" name="q" placeholder="Search this book" />
                  <span class="input-group-btn">
                    <button class="btn btn-primary" style="margin:0;" type="submit">
                      <i class="glyphicon glyphicon-search"></i>
                    </button>
                  </span>
                </div><!-- /input-group -->
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
            </li>
          </ul>
        </li>
        <!-- end search dropdown -->

        <li class="divider-vertical"></li>

        
        <li class="divider-vertical"></li>

        
      </ul>

      <ul class="nav navbar-nav">
        <li class="divider-vertical"></li>
        
          
          <li class="divider-vertical"></li>
        
        <!-- 
          
  <li id="relations-prev" title="Previous Chapter - <span class="section-number">11.3. </span>Lvalues, rvalues, and references" data-toggle="tooltip">
    <a href="rvalue.html" >
      <i class='glyphicon glyphicon-backward' style='opacity:0.9;'></i>
    </a>
  </li>
  
  <li id="relations-next" title='Next Chapter - <span class="section-number">11.5. </span>Allocators' data-toggle="tooltip" >              
    <a href="allocators.html" >
        <i class='glyphicon glyphicon-forward' style='opacity:0.9;'></i>
    </a>
  </li>
  <li class="divider-vertical"></li>

<script>
  opts = {'placement':'bottom',
          'selector': '',
          'delay': { show: 100, hide: 50}
         };

  window.addEventListener('load', (event) => {
    $('#relations-prev').tooltip(opts);
    $('#relations-next').tooltip(opts);
  });
</script>
        -->
        
          <li></li>
        
      </ul>
      </div> <!-- navbar-collapse -->
    </div> <!-- navbar -->
  </div> <!-- container -->


<div class="container" id="continue-reading"></div>

<div class="container" id="main-content" role="main">

	<div class="admonition note">
		<p class="admonition-title">
		Compiling in this book is temporarily broken.
		</p>
		<p>
		Until I have a chance to fix it, you can copy and paste code from the text area into an online compiler such as
		<a href="https://coliru.stacked-crooked.com/">Coliru</a>,
		<a href="https://www.onlinegdb.com/online_c++_compiler">Online GDB</a>, 
		<a href="https://godbolt.org/">GodBolt</a>, or
		<a href="https://replit.com/">Replit</a>. 
		Thank you for your patience.</p>
	</div>
	<!-- Ad Serving for Runestone Campaign -->
	

	
  <section id="moving-memory">
<span id="index-0"></span><h1><span class="section-number">11.4. </span>Moving memory<a class="headerlink" href="#moving-memory" title="Permalink to this heading">¶</a></h1>
<p>In the section on
<a class="reference internal" href="../class-II-functions/overloads.html"><span class="doc">Operator overloads</span></a> we briefly covered the
<a class="reference external" href="https://en.cppreference.com/w/cpp/algorithm/swap">std::swap</a> algorithm.
The implementation of swap for built in types is trivially
implemented:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">swap</span><span class="p">(</span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">   </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">   </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>However, even though <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> are both passed by
non-const reference, this is still an expensive function to call
for any type that is large or expensive to copy.</p>
<p>C++11 adds facilities that give programmers tools to replace expensive copies
with moves.
In C++11, if the right hand side of an expression is an <a class="reference internal" href="../glossary.html#term-rvalue"><span class="xref std std-term">rvalue</span></a> and
if the object supports moving, then moving memory is performed instead of
copying memory.
Given a potentially large type, such as <a class="reference external" href="https://en.cppreference.com/w/cpp/container/vector">vector</a>, we can re-write
the swap algorithm in terms of moves</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">swap</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&amp;&amp;&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"> </span><span class="c1">// cast to rvalue reference</span>
<span class="w">   </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&amp;&amp;&gt;</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="w">   </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&amp;&amp;&gt;</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Casting manually to a rvalue reference is ugly and awkward.
Simplifying this expression is the motivation behind <a class="reference external" href="https://en.cppreference.com/w/cpp/utility/move">move</a>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">swap</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"> </span><span class="c1">// cast to rvalue reference</span>
<span class="w">   </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="w">   </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">move</span></code> function simply converts it’s parameter into rvalue reference,
and marks the object as being ready for a ‘move’.
Using <code class="docutils literal notranslate"><span class="pre">std::move</span></code> is exactly the same as using a static cast to
an rvalue reference.</p>
<p>Just a moment ago, we mentioned a big ‘if’ regarding moves.
We said</p>
<blockquote>
<div><p>… if the object supports moving …</p>
</div></blockquote>
<p>How do we create objects that support moving?</p>
<p>With a move constructor.</p>
<section id="move-constructors-and-move-assignment">
<span id="index-1"></span><h2><span class="section-number">11.4.1. </span>Move constructors and move assignment<a class="headerlink" href="#move-constructors-and-move-assignment" title="Permalink to this heading">¶</a></h2>
<p>A move constructor is a constructor of the form:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">class_name</span><span class="w"> </span><span class="p">(</span><span class="n">class_name</span><span class="o">&amp;&amp;</span><span class="p">);</span>
</pre></div>
</div>
<p>Note that the parameter to the constructor is not a constant.
This is done for the same reasons swap functions take non-const references.
We pass non-constant rvalue references to our move constructors
so that we can exchange our current (empty) object for the one provided.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">::</span><span class="n">X</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// exchange content between other and this</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The move assignment operator is similar to copy assignment,
but with the now familiar rvalue reference parameter:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">&amp;</span><span class="w"> </span><span class="n">X</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">rhs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// exchange content between other and this</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Given 2 objects</span>
<span class="n">X</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">;</span>
<span class="c1">// do something to b</span>

<span class="c1">// We can copy them</span>
<span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>


<span class="c1">// Or force a move</span>
<span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</pre></div>
</div>
<p>As always we need to be concerned with what to do if our object
manages its own resources.
If class <code class="docutils literal notranslate"><span class="pre">X</span></code> has, for example, data on the free store,
then we need to ensure any resources that might create side effects
are addressed when we use move assignment.</p>
<p>If move semantics are implemented as a simple swap,
then the effect of this is that the objects held by <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> are
being exchanged between <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>.
Nothing is being destructed yet.
The object formerly held by <code class="docutils literal notranslate"><span class="pre">b</span></code> will of course be destructed eventually -
when <code class="docutils literal notranslate"><span class="pre">b</span></code> goes out of scope.
But if <code class="docutils literal notranslate"><span class="pre">a</span></code> also becomes the target of a move,
then the object formerly held by <code class="docutils literal notranslate"><span class="pre">a</span></code> gets passed on again.
As far as the implementer of the assignment operator is concerned,
it is not known when the object will be destructed.</p>
<p>So we have a small problem that needs to be fixed.
A variable has been assigned to,
but the object formerly held by that variable is still out there somewhere.
Any part of an object’s destruction that has side effects should be performed
explicitly in the rvalue reference overload of the assignment operator:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">&amp;</span><span class="w"> </span><span class="n">X</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">rhs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// Perform a cleanup that takes care of at least those parts of the</span>
<span class="w">  </span><span class="c1">// destructor that have side effects. Be sure to leave the object</span>
<span class="w">  </span><span class="c1">// in a destructible and assignable state.</span>

<span class="w">  </span><span class="c1">// exchange content between other and this</span>
<span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
<div class="admonition-more-to-explore admonition">
<p class="admonition-title">More to Explore</p>
<ul class="simple">
<li><p><a class="reference external" href="https://en.cppreference.com/w/cpp/language/move_constructor">Move constructors</a></p></li>
<li><p>The <a class="reference external" href="https://en.cppreference.com/w/cpp/algorithm/swap">std::swap</a> algorithm</p></li>
<li><p><a class="reference external" href="http://thbecker.net/articles/rvalue_references/section_01.html">C++ Rvalue references explained</a>
The content in this section was adapted from <em>Rvalue References Explained</em>, by Thomas Becker.</p></li>
<li><p><a class="reference external" href="https://mropert.github.io/2019/01/07/copy_swap_20_years/">Copy and Swap, 20 years later</a>
a deeper dive into some of the tradeoffs of different implementations of copy and move
assignment.</p></li>
</ul>
</div>
</section>
</section>


	

	<div id="scprogresscontainer">
		You have attempted <span id="scprogresstotal"></span> of <span id="scprogressposs"></span> activities on this page <div id="subchapterprogress" aria-label="Page progress"></div>
	</div>

	<ul role="navigation" class="nextprev-list nextprev-list" aria-label="Change page">
<li id="relations-prev" class="navLink" title='Previous Section - 11.3. Lvalues, rvalues, and references' data-toggle="tooltip">
  <a href="rvalue.html" aria-label="Previous - 11.3. Lvalues, rvalues, and references">
    <i class='prevNav glyphicon glyphicon-chevron-left'  style="top:50%; transform:translateY(-50%)translateX(-50%); left: 50%; color:black;"></i>
  </a>
</li>

  <li id="relations-next" class="navLink" title='Next Section - 11.5. Allocators' data-toggle="tooltip" >
    <a href="allocators.html" aria-label="Next - 11.5. Allocators">
      <i id="relationsNextIcon" class='nextNav glyphicon glyphicon-chevron-right' style="top:50%; transform:translateY(-50%)translateX(-50%); left: 50%; color:black; "></i>
    </a>
  </li>
</ul>

<script>
window.addEventListener('load', (event) => {
  $('#relations-prev').tooltip({'placement': 'right', 'delay': { show: 100, hide: 50}});
  $('#relations-next').tooltip({'placement': 'left', 'delay': { show: 100, hide: 50}});
});
</script>

</div>
<footer class="footer">
	<div class="container">
		<p class="pull-right">
		
		| <a href="#">Back to top</a>
		
		</p>
		<p>
		&copy; Copyright 2017-2023 Dave Parillo.
		Created using <a href="http://runestoneinteractive.org/">Runestone</a> 6.6.2.
		</p>
	</div>
</footer>




<script>
	window.addEventListener('load', (event) => {
		runestoneComponents.getSwitch();
	});
</script>


  </body>
</html>